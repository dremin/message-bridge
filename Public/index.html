<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Messages</title>
		<link rel="stylesheet" href="style.css" />
		<script type="text/javascript" src="json3.min.js"></script>
		<script type="text/javascript">
		var activeChat;
		var chats;
		var scrollBottom = false;
		
		function renderActiveChat() {
			var chatMessagesEl = document.getElementById("chat-messages");
			var messagesHtml = "";
			
			for(var i = 0; i < activeChat.messages.length; i++) {
				var cssClass = "message-remote";
				var from = "Myself";
				
				if (activeChat.messages[i].isMe === true && activeChat.service == "iMessage") {
					cssClass = "message-me-imessage";
				} else if (activeChat.messages[i].isMe === true) {
					cssClass = "message-me-sms";
				} else {
					from = activeChat.messages[i].from;
				}
				
				var itemHtml = "<div class='" + cssClass + "'><h4>" + from + "</h4><h4 class='message-date'>" + activeChat.messages[i].received + "</h4><p>" + activeChat.messages[i].body + "</p></div>";
				messagesHtml = itemHtml + messagesHtml;
			}
			
			chatMessagesEl.innerHTML = messagesHtml;
			
			if (scrollBottom) {
				var chatMessagesEl = document.getElementById("selected-chat");
				chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
				scrollBottom = false;
			}
		}
		
		function setActiveChat(index) {
			activeChat = chats[index];
			scrollBottom = true;
			renderChats();
			loadMessages(activeChat.id);
			
			var noSelectedChatEl = document.getElementById("no-selected-chat");
			noSelectedChatEl.style.display = "none";
			
			var selectedChatEl = document.getElementById("selected-chat");
			selectedChatEl.style.display = "block";
		}
		
		function renderChats() {
			var chatListEl = document.getElementById("chat-list");
			var listHtml = "";
			
			for(var i = 0; i < chats.length; i++) {
				var cssClass = "chat-list-item";
				if (activeChat && activeChat.id == chats[i].id) {
					cssClass += " chat-list-item-active";
				}
				var itemHtml = "<div class='" + cssClass + "' onClick='setActiveChat(" + i + ")'><h2>" + chats[i].name + "</h2><h3>" + chats[i].lastMessage + "</h3><h4>" + chats[i].lastReceived + "</h4></div>";
				listHtml += itemHtml;
			}
			
			chatListEl.innerHTML = listHtml;
		}
		
		function refresh() {
			load();
			
			if (activeChat) {
				loadMessages(activeChat.id);
			}
		}
		
		function loadCallback(status, text) {
			var newChats = JSON.parse(text);
			if (JSON.stringify(newChats) != JSON.stringify(chats)) {
				chats = newChats;
				renderChats();
			}
		}
		
		function load() {
			xhrExecute("GET", "messages?limit=20", "", loadCallback);
		}
		
		function loadMessagesCallback(status, text) {
			var newMessages = JSON.parse(text);
			if (JSON.stringify(newMessages) != JSON.stringify(activeChat.messages)) {
				activeChat.messages = newMessages;
				renderActiveChat();
			}
		}
		
		function loadMessages(chatId) {
			xhrExecute("GET", "messages/" + chatId + "?limit=20", "", loadMessagesCallback);
		}
		
		function sendMessageCallback(status, text) {
			loadMessages(activeChat.id);
			document.getElementById("message-input").value = "";
			load();
		}
		
		function sendMessage(event) {
			event.preventDefault();
			var body = {
				address: activeChat.replyId,
				service: activeChat.service,
				message: document.getElementById("message-input").value
			}
			xhrExecute("POST", "messages", body, sendMessageCallback);
		}
		
		function xhrExecute(method, endpoint, body, callback) {
			var xhr = new XMLHttpRequest();
			var url = '/' + endpoint;
			
			xhr.onreadystatechange = function() {
	            if ((xhr.readyState == 4 && xhr.status == 200) || (xhr.readyState >= 2 && xhr.status == 401)) {
	                callback(xhr.status, xhr.responseText); 
	            }
	        };
	        
	        xhr.open(method, url);			
			xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
			xhr.send(JSON.stringify(body));
		}
		
		load();
		setInterval(refresh, 3000);
		</script>
	</head>
	<body>
		<div id="chat-list"></div>
		<div id="no-selected-chat"><p>No chat selected</p></div>
		<div id="selected-chat">
			<div id="chat-messages"></div>
			<form onsubmit="sendMessage(event)">
				<input type="text" id="message-input" name="message" size="40" />
				<input type="submit" id="message-send" value="Send" />
			</form>
		</div>
		<div style="clear:both;"></div>
	</body>
</html>
